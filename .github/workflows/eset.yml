name: Account and Key Generator

on:
  # schedule: #if need schedule
  #   - cron: "0 */2 * * *"
  workflow_dispatch:
    inputs:
      account:
        description: "Number of Accounts to be generated (default = 0)"
        required: false
        default: "0"
        type: string
      key:
        description: "Number of Keys to be generated (default = 1)"
        required: false
        default: "1"
        type: string
      mail:
        description: "Choose the mail provider to generate license"
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
          - mailslurp
          - mailsac
          - tempmail
        default: emailfake
      key_type:
        description: "Modes of operation"
        required: true
        type: choice
        options:
          - --key
          - --small-business-key
        default: --key
      os:
        description: "Operating System of runner (Linux, macOS, Windows)"
        required: true
        type: choice
        options:
          - ubuntu-latest
          - macos-latest
          - windows-2019
        default: windows-2019
      branch:
        description: "Repository branch (don't touch it if you don't know what it is!!!)"
        required: false
        type: choice
        options:
          - main
          - test
        default: main
      use_vpn:
        description: "Enable Cloudflare WARP VPN"
        required: false
        type: boolean
        default: false
      generate_debug_artifacts:
        description: "Upload debug artifacts (debug_*)"
        required: false
        type: boolean
        default: false

jobs:
  generate-account-and-key:
    runs-on: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.os || 'windows-2019' }} #if fallback then
    steps:
      - name: Set Variables
        id: vars
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "account=${{ github.event.inputs.account }}" >> $GITHUB_OUTPUT
            echo "key=${{ github.event.inputs.key }}" >> $GITHUB_OUTPUT
            echo "mail=${{ github.event.inputs.mail }}" >> $GITHUB_OUTPUT
            echo "key_type=${{ github.event.inputs.key_type }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
            echo "use_vpn=${{ github.event.inputs.use_vpn }}" >> $GITHUB_OUTPUT
            echo "generate_debug_artifacts=${{ github.event.inputs.generate_debug_artifacts }}" >> $GITHUB_OUTPUT
            # Export to the job environment so Python can read it
            echo "GENERATE_DEBUG_ARTIFACTS=${{ github.event.inputs.generate_debug_artifacts }}" >> $GITHUB_ENV
          else #if fallback then
            echo "account=0" >> $GITHUB_OUTPUT
            echo "key=1" >> $GITHUB_OUTPUT
            echo "mail=emailfake" >> $GITHUB_OUTPUT
            echo "key_type=--key" >> $GITHUB_OUTPUT
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "use_vpn=false" >> $GITHUB_OUTPUT
            echo "generate_debug_artifacts=false" >> $GITHUB_OUTPUT
            echo "GENERATE_DEBUG_ARTIFACTS=false" >> $GITHUB_ENV
          fi

      - name: Set Email API Keys
        if: ${{ steps.vars.outputs.mail == 'mailslurp' || steps.vars.outputs.mail == 'mailsac' }}
        shell: bash
        run: |
          # Set API keys from GitHub Secrets only when the selected mail provider requires them
          if [[ "${{ steps.vars.outputs.mail }}" == "mailslurp" ]]; then
            [[ -n "${{ secrets.MAILSLURP_API_KEY }}" ]] && echo "MAILSLURP_API_KEY=${{ secrets.MAILSLURP_API_KEY }}" >> $GITHUB_ENV
          elif [[ "${{ steps.vars.outputs.mail }}" == "mailsac" ]]; then
            [[ -n "${{ secrets.MAILSAC_API_KEY }}" ]] && echo "MAILSAC_API_KEY=${{ secrets.MAILSAC_API_KEY }}" >> $GITHUB_ENV
          fi

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.branch }}

      - name: Setup Cloudflare WARP VPN
        if: runner.os == 'Linux' && steps.vars.outputs.use_vpn == 'true'
        shell: bash
        run: |
          echo "Installing Cloudflare WARP..."
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update
          sudo apt-get install -y cloudflare-warp

          echo "Registering WARP..."
          warp-cli registration new

          echo "Connecting to WARP..."
          warp-cli connect
          sleep 15

          echo "Waiting for WARP connection..."
          for i in {1..12}; do
            status=$(warp-cli status)
            echo "Status: $status"
            if echo "$status" | grep -q "Connected"; then
              echo "WARP is connected!"
              break
            fi
            sleep 5
          done

          echo "Checking connection..."
          curl -s https://www.cloudflare.com/cdn-cgi/trace/ | tee /dev/stderr | grep -q "warp=on" || echo "Warning: WARP may not be fully active"

      - name: Setup & Run Script (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install python@3.11 || true
          else
            sudo apt update
            sudo apt install -y python3-pip python3-venv
          fi

          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

          ACCOUNT="${{ steps.vars.outputs.account }}"
          KEY="${{ steps.vars.outputs.key }}"
          MAIL="${{ steps.vars.outputs.mail }}"
          KEY_TYPE="${{ steps.vars.outputs.key_type }}"

          if [[ "$ACCOUNT" != "0" ]]; then
            python3 main.py --auto-detect-browser --account --email-api "$MAIL" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat "$ACCOUNT"
            echo "Account:" >> $GITHUB_STEP_SUMMARY
            cat ./*ACCOUNTS.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "None" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$KEY" != "0" ]]; then
            python3 main.py --auto-detect-browser "$KEY_TYPE" --email-api "$MAIL" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat "$KEY"
            echo -e "\nKey:" >> $GITHUB_STEP_SUMMARY
            cat ./*KEYS.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "None" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup WARP VPN
        if: runner.os == 'Linux' && steps.vars.outputs.use_vpn == 'true' && always()
        shell: bash
        run: |
          warp-cli disconnect || true
          warp-cli registration delete || true

      - name: Setup Cloudflare WARP VPN (Windows)
        if: runner.os == 'Windows' && steps.vars.outputs.use_vpn == 'true'
        shell: pwsh
        run: |
          Write-Host "Installing Cloudflare WARP for Windows..."
          Invoke-WebRequest -Uri "https://1111-releases.cloudflareclient.com/windows/Cloudflare_WARP_Release-x64.msi" -OutFile "$env:TEMP\Cloudflare_WARP.msi"
          Start-Process msiexec.exe -Wait -ArgumentList "/i $env:TEMP\Cloudflare_WARP.msi /qn"
          Start-Sleep -Seconds 15

          $warpCli = "C:\Program Files\Cloudflare\Cloudflare WARP\warp-cli.exe"

          Write-Host "Accepting WARP ToS..."
          & $warpCli registration new
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Registration failed, trying license accept..."
            & $warpCli registration license accept
          }

          Write-Host "Connecting to WARP..."
          & $warpCli connect
          Start-Sleep -Seconds 15

          Write-Host "Waiting for WARP to be fully connected..."
          $maxRetries = 12
          $retryCount = 0
          while ($retryCount -lt $maxRetries) {
            $status = & $warpCli status
            Write-Host "Status: $status"
            if ($status -match "Connected") {
              Write-Host "WARP is connected!"
              break
            }
            Start-Sleep -Seconds 5
            $retryCount++
          }

          Write-Host "Checking connection..."
          $trace = Invoke-RestMethod -Uri "https://www.cloudflare.com/cdn-cgi/trace/"
          Write-Host $trace
          if ($trace -notmatch "warp=on") {
            Write-Warning "WARP may not be fully active, but continuing..."
          }

      - name: Setup & Run Script (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m venv venv
          .\venv\Scripts\pip install -r requirements.txt
          .\venv\Scripts\Activate.ps1
          # Export GENERATE_DEBUG_ARTIFACTS into the job environment for Python to read
          Write-Output "GENERATE_DEBUG_ARTIFACTS=${{ github.event.inputs.generate_debug_artifacts }}" | Out-File -FilePath $env:GITHUB_ENV -Append

          $ACCOUNT = "${{ steps.vars.outputs.account }}"
          $KEY = "${{ steps.vars.outputs.key }}"
          $MAIL = "${{ steps.vars.outputs.mail }}"
          $KEY_TYPE = "${{ steps.vars.outputs.key_type }}"

          if ($ACCOUNT -ne 0) {
            Write-Host "Generating $ACCOUNT account(s)..."
            $maxRetries = 3
            $retryCount = 0
            $success = $false
            
            while ($retryCount -lt $maxRetries -and -not $success) {
              try {
                if ($retryCount -gt 0) {
                  Write-Host "Retry attempt $retryCount of $maxRetries..."
                  Start-Sleep -Seconds 30
                }
                python main.py --auto-detect-browser --account --email-api "$MAIL" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat $ACCOUNT
                $success = $true
              } catch {
                Write-Host "Attempt failed: $_"
                $retryCount++
              }
            }
            
            echo "Account:" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            Get-Content -Path ./*ACCOUNTS.txt -ErrorAction SilentlyContinue | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            
            if (-not $success) {
              Write-Warning "Failed to generate accounts after $maxRetries attempts"
            }
          }

          if ($KEY -ne 0) {
            Write-Host "Generating $KEY key(s)..."
            $maxRetries = 3
            $retryCount = 0
            $success = $false
            
            while ($retryCount -lt $maxRetries -and -not $success) {
              try {
                if ($retryCount -gt 0) {
                  Write-Host "Retry attempt $retryCount of $maxRetries..."
                  Start-Sleep -Seconds 30
                }
                python main.py --auto-detect-browser "$KEY_TYPE" --email-api "$MAIL" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat $KEY
                $success = $true
              } catch {
                Write-Host "Attempt failed: $_"
                $retryCount++
              }
            }
            
            echo "`nKey:" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            Get-Content -Path ./*KEYS.txt -ErrorAction SilentlyContinue | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            
            if (-not $success) {
              Write-Error "Failed to generate keys after $maxRetries attempts"
              exit 1
            }
          }

      - name: Cleanup WARP VPN (Windows)
        if: runner.os == 'Windows' && steps.vars.outputs.use_vpn == 'true' && always()
        shell: pwsh
        run: |
          $warpCli = "C:\Program Files\Cloudflare\Cloudflare WARP\warp-cli.exe"
          if (Test-Path $warpCli) {
            Write-Host "Disconnecting WARP..."
            & $warpCli disconnect 2>&1 | Out-Null
            Start-Sleep -Seconds 3
            Write-Host "Deleting WARP registration..."
            & $warpCli registration delete 2>&1 | Out-Null
          }

      - name: Upload Generated Files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eset-keys-${{ github.run_number }}
          path: |
            *ACCOUNTS.txt
            *KEYS.txt
          if-no-files-found: ignore

      - name: Upload Debug Artifacts
        if: always() && steps.vars.outputs.generate_debug_artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: eset-debug-${{ github.run_number }}
          path: |
            debug_trial_page.html
            debug_trial_page.png
            debug_onboarding_stuck.html
            debug_onboarding_stuck.png
            debug_onboarding_state.json
            debug_subscription_detail.html
            debug_subscription_detail.png
            debug_subscription_detail.txt
            debug_subscription_full_text.txt
            debug_subscriptions_page.html
            debug_subscriptions_page.png
          if-no-files-found: ignore
